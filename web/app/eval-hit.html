<!-- HIT template: ImageTagging-v3.0 --><!-- Bootstrap v3.0.3 --><!-- Please note that Bootstrap CSS/JS and JQuery are 3rd party libraries that may update their url/code at any time. Amazon Mechanical Turk (MTurk) is including these libraries as a default option for you, but is not responsible for any changes to the external libraries -->
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" integrity="sha384-IS73LIqjtYesmURkDE9MXKbXqYA8rvKEp/ghicjem7Vc3mGRdQRptJSz60tvrB6+" rel="stylesheet" /><!-- The following snippet enables the 'responsive' behavior on smaller screens -->
<meta content="width=device-width,initial-scale=1" name="viewport" /><!-- Instructions -->
<section class="container" id="TaggingOfAnImage">
<div class="row">
<div class="col-xs-12 col-md-12"><!-- Instructions -->
<div class="panel panel-primary"><!-- WARNING: the ids "collapseTrigger" and "instructionBody" are being used to enable expand/collapse feature --><a class="panel-heading" href="javascript:void(0);" id="collapseTrigger"><strong>Instructions: Follow Directions in a Building</strong>&nbsp;<span class="collapse-text">(<u><span style="color:#0000FF;">Click to expand instructions</span></u>)</span> </a>
<div class="panel-body" id="instructionBody">
<p>Below the image you will see some navigation directions that describe how to reach a goal location. <strong>Your task is to follow the directions, by moving through the building to reach the goal location</strong>. On average, the goal location will be 5 to 15 meters away, typically in a different room. We will award a <strong> $0.10 bonus </strong> for every HIT that finishes within 3 meters of the goal location. We may reject HITs from workers that are consistently far below average in performance.</p>

<p>Further requirements:</p>

<ul>
	<li>You <strong>should not explore the building unnecessarily</strong>. Please go directly to the goal whenever possible.</li>
	<li>Please <strong>do not submit until you are as close as possible</strong> to where you think the goal is.</li>
	<li>You will be <strong>assessed on the distance from your final location to the goal</strong> (but it doesn&#39;t matter which direction you are facing).</li>
</ul>

<p>Mouse Controls:</p>

<ol>
	<li><strong>Left-click and drag the image</strong> to look around.</li>
	<li><strong>Right-click on a blue cylinder</strong> to move to that position (note: sometimes the blue cylinders are close to your feet, so you may need to look down).</li>
	<li><strong>Submit</strong> when you are as close as possible to the goal location.</li>
</ol>

<p>&nbsp;</p>

<p><strong>Note: <span style="color:#FF0000;">This task is not suitable for devices with small screens or touch screen devices</span></strong>. Recommended browsers are Chrome, Firefox and Safari (not Internet Explorer). Please do not submit HITs if you experience difficulties with the interface.</p>

<p style="font-size: 13px;">These tasks relate&nbsp;to academic research conducted by Peter Anderson through the <a href="https://www.roboticvision.org/">Australian Centre for Robotic Vision</a>, Brisbane, Australia. We estimate that on average each HIT to take around 1 minute to complete. Please send your queries and feedback to <strong>bringmeaspoon@gmail</strong>.</p>
</div>
</div>
</div>
</div>
<!-- End Instructions --><!-- Image Tagging Layout -->

<div class="row" id="workContent">
<div class="col-xs-12 col-sm-12 image">
<figure style="display: inline-block; width: 100%;"><canvas id="skybox" style="width:960px; height:540px; display: block; margin: 0 auto;"> </canvas></figure>
</div>

<div class="col-xs-12 col-sm-12 fields" style="text-align: center;">
<p id="instr">&nbsp;</p>

<p><i>(Left-click and drag the panoramic image to start. Don&#39;t submit until you reach the goal. Must read full instructions at top.)</i></p>
<input id="traj" name="traj" type="hidden" value="" /></div>
    <input id="stream_id" name="stream_id" type="hidden" value="" /></div>
    <input id="path_id" name="path_id" type="hidden" value="" /></div>
    <input id="instr_id" name="instr_id" type="hidden" value="" /></div>
    <input id="init_heading" name="init_heading" type="hidden" value="" /></div>

    <button id="load_prev_traj_btn"> Load Prev Traj </button>
    <button id="save_traj_btn"> Save Traj to File </button>
    <button id="load_next_traj_btn"> Load Next Traj </button>
    <button id="reload_traj_btn"> Reload Traj </button>
    <button id="clear_traj_btn"> Clear Traj </button>
    <button id="check_heading_btn"> Check Heading </button>

</div>
</section>
<!-- End Image Tagging Layout --><!-- Open internal style sheet -->
<style type="text/css">#collapseTrigger{
  color:#fff;
  display: block;
  text-decoration: none;
}
#submitButton{
  white-space: normal;
}
.image{
  margin-bottom: 15px;
}
.radio:first-of-type{
  margin-top: -5px;
}
img.loading {
  background: transparent url(http://thinkfuture.com/wp-content/uploads/2013/10/loading_spinner.gif) no-repeat scroll center center;
  min-height: 200px;
  min-width: 200px;
}
</style>
<!-- Close internal style sheet --><!-- Please note that Bootstrap CSS/JS and JQuery are 3rd party libraries that may update their url/code at any time. Amazon Mechanical Turk (MTurk) is including these libraries as a default option for you, but is not responsible for any changes to the external libraries --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js" integrity="sha384-s1ITto93iSMDxlp/79qhWHi+LsIi9Gx6yL+cOKDuymvihkfol83TYbLbOw+W/wv4" crossorigin="anonymous"></script><script type="text/javascript" crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.2/d3.min.js"></script><script type="text/javascript" crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/87/three.min.js"></script><script type="text/javascript" crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/16.3.5/Tween.min.js"></script>
<!--build:js js/main.min.js -->
<script type="text/javascript" src="js/RequestAnimationFrame.js"></script>
<script type="text/javascript" src="js/Detector.js"></script>
<script type="text/javascript" src="js/PTZCameraControls.js"></script>
<script type="text/javascript" src="js/Matterport3D.js"></script>
<!-- endbuild -->
<!--script type="text/javascript" crossorigin="anonymous" src="YOUR PUBLIC URL/js/main.min.js"></script-->
<script>
  $(document).ready(function() {
    // Instructions expand/collapse
    var content = $('#instructionBody');
    var trigger = $('#collapseTrigger');
    content.hide();
    $('.collapse-text').text('(Click to expand)');
    trigger.click(function(){
      content.toggle();
      var isVisible = content.is(':visible');
      if(isVisible){
        $('.collapse-text').text('(Click to collapse)');
      }else{
        $('.collapse-text').text('(Click to expand)');
      }
    });
    // end expand/collapse
  });
</script><script>
//var ix = ${ix}   // UNCOMMENT THIS LINE WHEN INTEGRATING WITH AMT
var ix = location.search.split('ix=')[1];   // UNCOMMENT THIS LINE TO RUN UI LOCALLY WITH GULP
var scan;
var curr_image_id;

// declare a bunch of variable we will need later
var camera, camera_pose, scene, controls, renderer, connections, id_to_ix, world_frame, cylinder_frame, cubemap_frame;
var mouse = new THREE.Vector2();
var id, last_pose;

var SIZE_X = 960;
var SIZE_Y = 540;
var VFOV = 90;
var ASPECT = SIZE_X/SIZE_Y;
var path;

var matt = new Matterport3D("");

var split = "sampled_paths";
var r2r_indices = [
{ 'traj_idx': '207', 'stream': 'consistent', 'instr_id': '1164471_0'},
{ 'traj_idx': '47', 'stream': 'MLE', 'instr_id': '1035068_0'},
{ 'traj_idx': '215', 'stream': 'MLE', 'instr_id': '1018023_0'},
{ 'traj_idx': '181', 'stream': 'consistent', 'instr_id': '1167427_0'},
{ 'traj_idx': '119', 'stream': 'greedy', 'instr_id': '1078123_0'},
{ 'traj_idx': '89', 'stream': 'consistent', 'instr_id': '1121220_0'},
{ 'traj_idx': '45', 'stream': 'greedy', 'instr_id': '1159862_0'},
{ 'traj_idx': '30', 'stream': 'greedy', 'instr_id': '1173390_0'},
{ 'traj_idx': '145', 'stream': 'consistent', 'instr_id': '1174944_0'},
{ 'traj_idx': '212', 'stream': 'MLE', 'instr_id': '1088931_0'},
{ 'traj_idx': '142', 'stream': 'MLE', 'instr_id': '1155809_0'},
{ 'traj_idx': '65', 'stream': 'greedy', 'instr_id': '1081591_0'},
{ 'traj_idx': '122', 'stream': 'MLE', 'instr_id': '1058822_0'},
{ 'traj_idx': '96', 'stream': 'greedy', 'instr_id': '1140884_0'},
{ 'traj_idx': '157', 'stream': 'MLE', 'instr_id': '1163679_0'},
{ 'traj_idx': '70', 'stream': 'consistent', 'instr_id': '1110352_0'},
{ 'traj_idx': '75', 'stream': 'MLE', 'instr_id': '1108162_0'},
{ 'traj_idx': '23', 'stream': 'MLE', 'instr_id': '1171532_0'},
{ 'traj_idx': '182', 'stream': 'MLE', 'instr_id': '1177411_0'},
{ 'traj_idx': '184', 'stream': 'greedy', 'instr_id': '1142259_0'},
{ 'traj_idx': '32', 'stream': 'MLE', 'instr_id': '1139263_0'},
{ 'traj_idx': '59', 'stream': 'greedy', 'instr_id': '1003748_0'},
{ 'traj_idx': '144', 'stream': 'greedy', 'instr_id': '1048969_0'},
{ 'traj_idx': '76', 'stream': 'greedy', 'instr_id': '1036188_0'},
{ 'traj_idx': '126', 'stream': 'greedy', 'instr_id': '1173708_0'},
{ 'traj_idx': '66', 'stream': 'consistent', 'instr_id': '1089733_0'},
{ 'traj_idx': '158', 'stream': 'greedy', 'instr_id': '1027221_0'},
{ 'traj_idx': '148', 'stream': 'MLE', 'instr_id': '1093153_0'},
{ 'traj_idx': '169', 'stream': 'consistent', 'instr_id': '1159102_0'},
{ 'traj_idx': '198', 'stream': 'MLE', 'instr_id': '1107884_0'},
{ 'traj_idx': '125', 'stream': 'MLE', 'instr_id': '1007002_0'},
{ 'traj_idx': '99', 'stream': 'consistent', 'instr_id': '1045707_0'},
{ 'traj_idx': '48', 'stream': 'greedy', 'instr_id': '1173679_0'},
{ 'traj_idx': '37', 'stream': 'consistent', 'instr_id': '1035040_0'},
{ 'traj_idx': '175', 'stream': 'MLE', 'instr_id': '1105894_0'},
{ 'traj_idx': '102', 'stream': 'consistent', 'instr_id': '1116206_0'},
{ 'traj_idx': '46', 'stream': 'consistent', 'instr_id': '1119382_0'},
{ 'traj_idx': '60', 'stream': 'consistent', 'instr_id': '1003625_0'},
{ 'traj_idx': '149', 'stream': 'greedy', 'instr_id': '1031398_0'},
{ 'traj_idx': '162', 'stream': 'greedy', 'instr_id': '1043527_0'},
{ 'traj_idx': '219', 'stream': 'greedy', 'instr_id': '1043900_0'},
{ 'traj_idx': '174', 'stream': 'consistent', 'instr_id': '1150864_0'},
{ 'traj_idx': '109', 'stream': 'consistent', 'instr_id': '1123050_0'},
{ 'traj_idx': '100', 'stream': 'MLE', 'instr_id': '1147008_0'},
{ 'traj_idx': '220', 'stream': 'consistent', 'instr_id': '1018930_0'},
{ 'traj_idx': '72', 'stream': 'MLE', 'instr_id': '1133450_0'},
{ 'traj_idx': '20', 'stream': 'MLE', 'instr_id': '1001207_0'},
{ 'traj_idx': '33', 'stream': 'greedy', 'instr_id': '1174063_0'},
{ 'traj_idx': '108', 'stream': 'greedy', 'instr_id': '1077800_0'},
{ 'traj_idx': '52', 'stream': 'greedy', 'instr_id': '1007159_0'},
{ 'traj_idx': '165', 'stream': 'MLE', 'instr_id': '1155638_0'},
{ 'traj_idx': '43', 'stream': 'MLE', 'instr_id': '1040834_0'},
{ 'traj_idx': '208', 'stream': 'MLE', 'instr_id': '1143000_0'},
{ 'traj_idx': '79', 'stream': 'greedy', 'instr_id': '1093944_0'},
{ 'traj_idx': '78', 'stream': 'MLE', 'instr_id': '1007845_0'},
{ 'traj_idx': '49', 'stream': 'consistent', 'instr_id': '1122433_0'},
{ 'traj_idx': '115', 'stream': 'MLE', 'instr_id': '1054888_0'},
{ 'traj_idx': '39', 'stream': 'MLE', 'instr_id': '1043289_0'},
{ 'traj_idx': '28', 'stream': 'consistent', 'instr_id': '1082013_0'},
{ 'traj_idx': '80', 'stream': 'consistent', 'instr_id': '1160039_0'},
{ 'traj_idx': '203', 'stream': 'consistent', 'instr_id': '1031139_0'},
{ 'traj_idx': '180', 'stream': 'greedy', 'instr_id': '1006028_0'},
{ 'traj_idx': '132', 'stream': 'MLE', 'instr_id': '1170100_0'},
{ 'traj_idx': '136', 'stream': 'greedy', 'instr_id': '1076125_0'},
{ 'traj_idx': '202', 'stream': 'greedy', 'instr_id': '1062004_0'},
{ 'traj_idx': '42', 'stream': 'consistent', 'instr_id': '1027985_0'},
{ 'traj_idx': '217', 'stream': 'consistent', 'instr_id': '1129153_0'},
{ 'traj_idx': '172', 'stream': 'greedy', 'instr_id': '1046697_0'},
{ 'traj_idx': '137', 'stream': 'consistent', 'instr_id': '1110985_0'},
{ 'traj_idx': '77', 'stream': 'consistent', 'instr_id': '1087020_0'},
{ 'traj_idx': '155', 'stream': 'greedy', 'instr_id': '1150226_0'},
{ 'traj_idx': '113', 'stream': 'greedy', 'instr_id': '1165278_0'},
{ 'traj_idx': '227', 'stream': 'greedy', 'instr_id': '1120198_0'},
{ 'traj_idx': '118', 'stream': 'MLE', 'instr_id': '1088530_0'},
{ 'traj_idx': '133', 'stream': 'greedy', 'instr_id': '1021209_0'},
{ 'traj_idx': '57', 'stream': 'consistent', 'instr_id': '1083243_0'},
{ 'traj_idx': '189', 'stream': 'consistent', 'instr_id': '1156702_0'},
{ 'traj_idx': '152', 'stream': 'greedy', 'instr_id': '1116042_0'},
{ 'traj_idx': '171', 'stream': 'MLE', 'instr_id': '1140103_0'},
{ 'traj_idx': '68', 'stream': 'MLE', 'instr_id': '1169226_0'},
{ 'traj_idx': '105', 'stream': 'consistent', 'instr_id': '1014303_0'},
{ 'traj_idx': '94', 'stream': 'consistent', 'instr_id': '1009195_0'},
{ 'traj_idx': '159', 'stream': 'consistent', 'instr_id': '1098038_0'},
{ 'traj_idx': '224', 'stream': 'consistent', 'instr_id': '1006998_0'},
{ 'traj_idx': '107', 'stream': 'MLE', 'instr_id': '1086867_0'},
{ 'traj_idx': '101', 'stream': 'greedy', 'instr_id': '1135658_0'},
{ 'traj_idx': '196', 'stream': 'consistent', 'instr_id': '1145987_0'},
{ 'traj_idx': '73', 'stream': 'greedy', 'instr_id': '1169727_0'},
{ 'traj_idx': '64', 'stream': 'MLE', 'instr_id': '1017277_0'},
{ 'traj_idx': '24', 'stream': 'greedy', 'instr_id': '1134365_0'},
{ 'traj_idx': '176', 'stream': 'greedy', 'instr_id': '1150928_0'},
{ 'traj_idx': '225', 'stream': 'MLE', 'instr_id': '1089589_0'},
{ 'traj_idx': '193', 'stream': 'MLE', 'instr_id': '1118003_0'},
{ 'traj_idx': '21', 'stream': 'greedy', 'instr_id': '1166925_0'},
{ 'traj_idx': '161', 'stream': 'MLE', 'instr_id': '1038745_0'},
{ 'traj_idx': '177', 'stream': 'consistent', 'instr_id': '1144911_0'},
{ 'traj_idx': '22', 'stream': 'consistent', 'instr_id': '1118014_0'},
{ 'traj_idx': '92', 'stream': 'greedy', 'instr_id': '1119819_0'},
{ 'traj_idx': '223', 'stream': 'greedy', 'instr_id': '1045262_0'},
{ 'traj_idx': '103', 'stream': 'MLE', 'instr_id': '1071916_0'},
{ 'traj_idx': '117', 'stream': 'consistent', 'instr_id': '1093733_0'},
{ 'traj_idx': '112', 'stream': 'MLE', 'instr_id': '1156066_0'},
{ 'traj_idx': '214', 'stream': 'consistent', 'instr_id': '1161273_0'},
{ 'traj_idx': '179', 'stream': 'MLE', 'instr_id': '1125491_0'},
{ 'traj_idx': '194', 'stream': 'greedy', 'instr_id': '1153617_0'},
{ 'traj_idx': '124', 'stream': 'consistent', 'instr_id': '1051267_0'},
{ 'traj_idx': '164', 'stream': 'consistent', 'instr_id': '1094709_0'},
{ 'traj_idx': '123', 'stream': 'greedy', 'instr_id': '1105136_0'},
{ 'traj_idx': '129', 'stream': 'consistent', 'instr_id': '1156224_0'},
{ 'traj_idx': '156', 'stream': 'consistent', 'instr_id': '1137070_0'},
{ 'traj_idx': '151', 'stream': 'MLE', 'instr_id': '1100829_0'},
{ 'traj_idx': '134', 'stream': 'consistent', 'instr_id': '1005814_0'},
{ 'traj_idx': '51', 'stream': 'MLE', 'instr_id': '1135266_0'},
{ 'traj_idx': '95', 'stream': 'MLE', 'instr_id': '1013976_0'},
{ 'traj_idx': '213', 'stream': 'greedy', 'instr_id': '1112596_0'},
{ 'traj_idx': '91', 'stream': 'MLE', 'instr_id': '1150941_0'},
{ 'traj_idx': '29', 'stream': 'MLE', 'instr_id': '1002044_0'},
{ 'traj_idx': '153', 'stream': 'consistent', 'instr_id': '1147641_0'},
{ 'traj_idx': '53', 'stream': 'consistent', 'instr_id': '1163164_0'},
{ 'traj_idx': '211', 'stream': 'consistent', 'instr_id': '1031841_0'},
{ 'traj_idx': '69', 'stream': 'greedy', 'instr_id': '1044591_0'},
{ 'traj_idx': '40', 'stream': 'greedy', 'instr_id': '1055559_0'},
{ 'traj_idx': '56', 'stream': 'greedy', 'instr_id': '1152386_0'},
{ 'traj_idx': '167', 'stream': 'greedy', 'instr_id': '1073651_0'},
{ 'traj_idx': '199', 'stream': 'greedy', 'instr_id': '1007780_0'},
{ 'traj_idx': '216', 'stream': 'greedy', 'instr_id': '1040735_0'},
{ 'traj_idx': '114', 'stream': 'consistent', 'instr_id': '1056311_0'},
{ 'traj_idx': '87', 'stream': 'greedy', 'instr_id': '1093140_0'},
{ 'traj_idx': '58', 'stream': 'MLE', 'instr_id': '1175180_0'},
{ 'traj_idx': '138', 'stream': 'MLE', 'instr_id': '1008687_0'},
{ 'traj_idx': '150', 'stream': 'consistent', 'instr_id': '1030859_0'},
{ 'traj_idx': '206', 'stream': 'greedy', 'instr_id': '1089575_0'},
{ 'traj_idx': '139', 'stream': 'greedy', 'instr_id': '1063984_0'},
{ 'traj_idx': '228', 'stream': 'consistent', 'instr_id': '1146981_0'},
{ 'traj_idx': '200', 'stream': 'consistent', 'instr_id': '1007722_0'},
{ 'traj_idx': '205', 'stream': 'MLE', 'instr_id': '1073103_0'},
{ 'traj_idx': '221', 'stream': 'MLE', 'instr_id': '1106706_0'},
{ 'traj_idx': '81', 'stream': 'MLE', 'instr_id': '1023776_0'},
{ 'traj_idx': '116', 'stream': 'greedy', 'instr_id': '1127502_0'},
{ 'traj_idx': '135', 'stream': 'MLE', 'instr_id': '1127811_0'},
{ 'traj_idx': '104', 'stream': 'greedy', 'instr_id': '1147174_0'},
{ 'traj_idx': '31', 'stream': 'consistent', 'instr_id': '1066530_0'},
{ 'traj_idx': '141', 'stream': 'consistent', 'instr_id': '1043321_0'},
{ 'traj_idx': '74', 'stream': 'consistent', 'instr_id': '1092648_0'},
{ 'traj_idx': '154', 'stream': 'MLE', 'instr_id': '1081377_0'},
{ 'traj_idx': '218', 'stream': 'MLE', 'instr_id': '1135663_0'},
{ 'traj_idx': '201', 'stream': 'MLE', 'instr_id': '1107391_0'},
{ 'traj_idx': '120', 'stream': 'consistent', 'instr_id': '1057723_0'},
{ 'traj_idx': '210', 'stream': 'greedy', 'instr_id': '1032142_0'},
{ 'traj_idx': '55', 'stream': 'MLE', 'instr_id': '1084294_0'}

];

var cur_index = 147;
var r2r_data = {
    "greedy": null,
    "MLE": null,
    "consistent": null
};

matt.loadJson('/R2Rdata/'+split+'_greedy.json').then(function(greedy_data){
    r2r_data["greedy"] = greedy_data;

    matt.loadJson('/R2Rdata/'+split+'_MLE.json').then(function(MLE_data){
        r2r_data["MLE"] = MLE_data;

        matt.loadJson('/R2Rdata/'+split+'_consistent.json').then(function(consistent_data){
            r2r_data["consistent"] = consistent_data;
            my_load_path_scene();
        });
    });
});


function my_load_path_scene() {

    skybox_init();

    if($('#traj').val() !== ""){
        alert("traj is not empty! this should not have happened. The system maybe in inconsistent state. manual intervention maybe required.");
        return
    }

    var instr_id = r2r_indices[cur_index]["instr_id"];
    var stream = r2r_indices[cur_index]["stream"];

    // alert(ind + " " + stream);

    task = r2r_data[stream][instr_id];

    // alert(task);

    console.log("loading scene at the selected index = " + cur_index +
        " and r2r index = " + instr_id + " with path_id = " + task['path_id'] + " taking from stream " + stream);

    scan = task['scan'];
    curr_image_id = task['path'][0];
    instructions = task['instructions'][0];
    $('#instr').text(instructions);
    $('#path_id').val(task['path_id']);
    $('#instr_id').val(instr_id);
    $('#init_heading').val(task['heading']);
    $('#stream_id').val(stream);
    $('#save_traj_btn').text("Save Traj for ("+cur_index+", "+instr_id+", "+task["path_id"]+") to File");

    load_connections(scan, curr_image_id);
}

function my_load_prev_traj() {

    if($('#traj').val() !== ""){
        alert("cannot load prev scene the traj is not empty");
        return
    }

    if(cur_index === 0) {
        alert("sorry bro, can't decrement, already at 0");
        return
    }
    cur_index  = cur_index  - 1;
    my_load_path_scene();
}

function my_load_next_traj() {

    // if($('#traj').val() !== ""){
    //     alert("cannot load next scene the traj is not empty");
    //     return
    // }
    $('#traj').val('');

    if(cur_index === r2r_indices.length - 1){
        alert("sorry bro, can't increment, already at max index");
        return;
    }
    cur_index  = cur_index  + 1;
    my_load_path_scene();
}

$("#load_prev_traj_btn").click(my_load_prev_traj);
$("#load_next_traj_btn").click(my_load_next_traj);


function send_traj_for_saving() {

    console.log("sending " + $('#stream_id').val() + $('#path_id').val());
    console.log("traj is " + $('#traj').val());
    console.log("sending now.. " + $('#stream_id').val() + $('#path_id').val());

    $.post( "http://0.0.0.0:5000/traj_dump/", {
        stream_id: $('#stream_id').val(),
        split: split,
        path_id: $('#path_id').val(),
        instr_id: $('#instr_id').val(),
        instr: $('#instr').text(),
        traj: $('#traj').val(),
    },

        function (data) {
            if(data.slice(0,7) === "Success") {
                console.log("Sucess detected. Clearing Traj");
                clear_traj_history();
                console.log("Looks like we cleared traj: '" + $('#traj').val() + "'");
                console.log("Loading next..");
                my_load_next_traj();
                console.log("we may have loaded the new trajectory")
            }
            else if (data.slice(0,5) === "Error"){
                alert("error detected");
                alert("flask says..  " + data);
            }
            else {
                alert("what the hell is " + data);
            }
        }
    );
}

$('#save_traj_btn').click(send_traj_for_saving);

function clear_traj_history() {
    $('#traj').val('');
}


function reload_scene() {
    clear_traj_history();
    last_pose = null;
    my_load_path_scene();
}

$('#reload_traj_btn').click(reload_scene);
$('#clear_traj_btn').click(clear_traj_history);


function my_check_heading() {
    var init_heading = $('#init_heading').val();

    var m = get_camera_pose();

    // calculate heading
    var rot = new THREE.Matrix3();
    rot.setFromMatrix4(m);
    var cam_look = new THREE.Vector3(0,0,1); // based on matterport camera
    cam_look.applyMatrix3(rot);
    var heading = Math.PI/2.0 -Math.atan2(cam_look.y, cam_look.x);
    if (heading < 0) {
        heading += 2.0*Math.PI;
    }

    alert("initial heading is supposed to be " + init_heading + " while current heading is " + heading);
}

$('#check_heading_btn').click(my_check_heading);

// ## Initialize everything
function skybox_init(scan, image) {
  // test if webgl is supported
  if (! Detector.webgl) Detector.addGetWebGLMessage();

  // create the camera (kinect 2)
  camera = new THREE.PerspectiveCamera(VFOV, ASPECT, 0.01, 1000);
  camera_pose = new THREE.Group();
  camera_pose.add(camera);
  
  // create the Matterport world frame
  world_frame = new THREE.Group();
  
  // create the cubemap frame
  cubemap_frame = new THREE.Group();
  cubemap_frame.rotation.x = -Math.PI; // Adjust cubemap for z up
  cubemap_frame.add(world_frame);
  
  // create the Scene
  scene = new THREE.Scene();
  world_frame.add(camera_pose);
  scene.add(cubemap_frame);

  var light = new THREE.DirectionalLight( 0xFFFFFF, 1 );
  light.position.set(0, 0, 100);
  world_frame.add(light);
  world_frame.add(new THREE.AmbientLight( 0xAAAAAA )); // soft light

  // init the WebGL renderer
  renderer = new THREE.WebGLRenderer({canvas: document.getElementById("skybox"), antialias: true } );
  renderer.setSize(SIZE_X, SIZE_Y);

  controls = new THREE.PTZCameraControls(camera, renderer.domElement);
  controls.minZoom = 1;
  controls.maxZoom = 3.0;
  controls.minTilt = -0.6*Math.PI/2;
  controls.maxTilt = 0.6*Math.PI/2;
  controls.enableDamping = true;
  controls.panSpeed = -0.25;
  controls.tiltSpeed = -0.25;
  controls.zoomSpeed = 1.5;
  controls.dampingFactor = 0.5;
  controls.addEventListener( 'select', select );
  controls.addEventListener( 'change', render );
  controls.addEventListener( 'rotate', log_pose );
}

function select(event) {
  var mouse = new THREE.Vector2();
  var raycaster = new THREE.Raycaster();
  mouse.x = ( event.x / SIZE_X ) * 2 - 1;
  mouse.y = - ( event.y / SIZE_Y ) * 2 + 1;
  raycaster.setFromCamera( mouse, camera );
  var intersects = raycaster.intersectObjects( cylinder_frame.children );
  if ( intersects.length > 0 ) {
    intersects[0].object.currentHex = intersects[0].object.material.emissive.getHex();
    intersects[0].object.material.emissive.setHex( 0xff0000 );
    image_id = intersects[ 0 ].object.name;
    take_action(image_id);
    setTimeout(function(){ intersects[0].object.material.emissive.setHex( intersects[0].object.currentHex ); }, 200);
  }
}

function load_connections(scan, image_id) {
  var pose_url  = "/connectivity/"+scan+"_connectivity.json";
  d3.json(pose_url, function(error, data) {
    if (error) return console.warn(error);
    connections = data;
    // Create a cylinder frame for showing arrows of directions
    cylinder_frame = matt.load_viewpoints(data);
    // Keep a structure of connection graph
    id_to_ix = {};
    for (var i = 0; i < data.length; i++) {
      var im = data[i]['image_id'];
      id_to_ix[im] = i;
    }
    world_frame.add(cylinder_frame);
    matt.loadCubeTexture(cube_urls(scan, image_id)).then(function(texture){
      scene.background = texture;
      move_to(image_id, true);
    });
  });
}

function cube_urls(scan, image_id) {
  var urlPrefix  = "data/v1/scans/" + scan + "/matterport_skybox_images/" + image_id;
  return [ urlPrefix + "_skybox2_sami.jpg", urlPrefix + "_skybox4_sami.jpg",
      urlPrefix + "_skybox0_sami.jpg", urlPrefix + "_skybox5_sami.jpg",
      urlPrefix + "_skybox1_sami.jpg", urlPrefix + "_skybox3_sami.jpg" ];
}

function move_to(image_id, isInitial=false) {
  // Adjust cylinder visibility
    console.log("moving to " + image_id);
  var cylinders = cylinder_frame.children;
  for (var i = 0; i < cylinders.length; ++i){
    cylinders[i].visible = connections[id_to_ix[image_id]]['unobstructed'][i];
  }
  // Correct world frame for individual skybox camera rotation
  var inv = new THREE.Matrix4();
  var cam_pose = cylinder_frame.getObjectByName(image_id);
  inv.getInverse(cam_pose.matrix);
  var ignore = new THREE.Vector3();
  inv.decompose(ignore, world_frame.quaternion, world_frame.scale);
  world_frame.updateMatrix();
  if (isInitial){
    set_camera_pose(cam_pose.matrix, cam_pose.height);
  } else {
    set_camera_position(cam_pose.matrix, cam_pose.height);
  }
  render();
  curr_image_id = image_id;
  log_pose();
}

function set_camera_pose(matrix4d, height){
  matrix4d.decompose(camera_pose.position, camera_pose.quaternion, camera_pose.scale);
  camera_pose.position.z += height;
  camera_pose.rotateX(Math.PI); // convert matterport camera to webgl camera
}

function set_camera_position(matrix4d, height) {
  var ignore_q = new THREE.Quaternion();
  var ignore_s = new THREE.Vector3();
  matrix4d.decompose(camera_pose.position, ignore_q, ignore_s);
  camera_pose.position.z += height;
}

function get_camera_pose(){
  camera.updateMatrix();
  camera_pose.updateMatrix();
  var m = camera.matrix.clone();
  m.premultiply(camera_pose.matrix);
  return m;
}

Math.degrees = function(radians) {
  return radians * 180 / Math.PI;
};

function log_pose() {
  var pose = get_pose_string();
  if (pose !== last_pose) {
    $('#traj').val($('#traj').val()+','+pose);
    last_pose = pose;
  }
}

function get_pose_string(){
  var m = get_camera_pose();

  // calculate heading
  var rot = new THREE.Matrix3();
  rot.setFromMatrix4(m);
  var cam_look = new THREE.Vector3(0,0,1); // based on matterport camera
  cam_look.applyMatrix3(rot);
  heading = Math.PI/2.0 -Math.atan2(cam_look.y, cam_look.x);
  if (heading < 0) {
    heading += 2.0*Math.PI;
  }

  // calculate elevation
  elevation = -Math.atan2(cam_look.z, Math.sqrt(Math.pow(cam_look.x,2) + Math.pow(cam_look.y,2)))
  
  return "("+curr_image_id+","+Math.degrees(heading)+","+Math.degrees(elevation)+")";
}

function take_action(image_id) {
  var texture_promise = matt.loadCubeTexture(cube_urls(scan, image_id)); // start fetching textures
  var target = cylinder_frame.getObjectByName(image_id);

  // Camera up vector
  var camera_up = new THREE.Vector3(0,1,0);
  var camera_look = new THREE.Vector3(0,0,-1);
  var camera_m = get_camera_pose();
  var zero = new THREE.Vector3(0,0,0);
  camera_m.setPosition(zero);
  camera_up.applyMatrix4(camera_m);
  camera_up.normalize();
  camera_look.applyMatrix4(camera_m);
  camera_look.normalize();

  // look direction
  var look = target.position.clone();
  look.sub(camera_pose.position);
  look.projectOnPlane(camera_up);
  look.normalize();
  // Simplified - assumes z is zero
  var rotate = Math.atan2(look.y,look.x) - Math.atan2(camera_look.y,camera_look.x);
  if (rotate < -Math.PI) rotate += 2*Math.PI;
  if (rotate > Math.PI) rotate -= 2*Math.PI;

  var target_y = camera.rotation.y + rotate;
  var rotate_tween = new TWEEN.Tween({
    x: camera.rotation.x,
    y: camera.rotation.y,
    z: camera.rotation.z})
  .to( {
    x: camera.rotation.x,
    y: target_y,
    z: 0 }, 2000*Math.abs(rotate) )
  .easing( TWEEN.Easing.Cubic.InOut)
  .onUpdate(function() {
    camera.rotation.x = this.x;
    camera.rotation.y = this.y;
    camera.rotation.z = this.z;
    render();
  });
  var new_vfov = VFOV*0.95;
  var zoom_tween = new TWEEN.Tween({
    vfov: VFOV})
  .to( {vfov: new_vfov }, 500 )
  .easing(TWEEN.Easing.Cubic.InOut)
  .onUpdate(function() {
    camera.fov = this.vfov;
    camera.updateProjectionMatrix();
    render();
  })
  .onComplete(function(){
    cancelAnimationFrame(id);
    texture_promise.then(function(texture) {
      scene.background = texture; 
      camera.fov = VFOV;
      camera.updateProjectionMatrix();
      move_to(image_id);
    });
  });
  rotate_tween.chain(zoom_tween);
  animate();
  rotate_tween.start();
}

// Display the Scene
function render() {
  renderer.render(scene, camera);
}

// tweening
function animate() {
  id = requestAnimationFrame( animate );
  TWEEN.update();
}
</script>
